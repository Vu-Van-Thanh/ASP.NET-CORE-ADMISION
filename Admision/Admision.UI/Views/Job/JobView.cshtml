<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biểu đồ Highcharts</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/mapdata/countries/vn/vn-all.js"></script>
</head>
<body>
    <h1>Biểu đồ Tuyển Dụng</h1>

    <!-- Biểu đồ Số lượng công việc theo tỉnh thành -->
    <div id="cityChart" style="width: 100%; height: 400px;"></div>

    <!-- Biểu đồ Tỷ lệ công việc theo loại hình -->
    <div id="typeChart" style="width: 100%; height: 400px;"></div>

    <!-- Biểu đồ Mức lương trung bình theo cấp bậc -->
    <div id="salaryChart" style="width: 100%; height: 400px;"></div>

    <!-- Biểu đồ Số lượng công việc và lương trung bình theo ngành -->
    <div id="combinedChart" style="width: 100%; height: 400px;"></div>

    <!-- Biểu đồ Bản đồ công việc -->
    <div id="mapChart" style="width: 100%; height: 600px;"></div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            // Dữ liệu mặc định
            const defaultJobs = [
                { province: "Hà Nội", major: "Công nghệ thông tin", type: "Toàn thời gian", level: "Nhân viên", minWage:900, maxWage:1200, wage: 1200, amount: 10 },
                { province: "Hồ Chí Minh", major: "Kỹ thuật", type: "Toàn thời gian", level: "Trưởng nhóm", minWage:1200, maxWage:1500, wage: 1500, amount: 5 },
                { province: "Đà Nẵng", major: "Kinh doanh", type: "Bán thời gian", level: "Thực tập sinh", minWage:200, maxWage:500, wage: 500, amount: 3 },
                { province: "Hà Nội", major: "Kinh doanh", type: "Toàn thời gian", level: "Nhân viên", minWage:700, maxWage:1000 , wage: 1000, amount: 8 },
                { province: "Hồ Chí Minh", major: "Công nghệ thông tin", type: "Toàn thời gian", level: "Nhân viên", minWage:900, maxWage:1300, wage: 1300, amount: 12 }
            ];

            let jobs = [];

            try {
                // Fetch dữ liệu từ API (cập nhật URL phù hợp)
                const response = await fetch("/Job/GetAllJobByFilter");
                if (response.ok) {
                    const data = await response.json();
                    console.log(data);
                    

                    jobs = data.length > 0 ? data : defaultJobs;
                } else {
                    console.error("Không thể tải dữ liệu từ API. Sử dụng dữ liệu mặc định.");

                    jobs = defaultJobs;
                }
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu:", error);
                jobs = defaultJobs;
            }

            // Render các biểu đồ sau khi có dữ liệu
            renderCharts(jobs);
        });

        function renderCharts(jobs) {
            // 1. Số lượng công việc theo tỉnh thành
            const jobCountByCity = jobs.reduce((acc, job) => {
                acc[job.province] = (acc[job.province] || 0) + job.amount;
                return acc;
            }, {});
            const chartData1 = Object.entries(jobCountByCity).map(([city, count]) => ({ name: city, y: count }));

            Highcharts.chart('cityChart', {
                chart: { type: 'column' },
                title: { text: 'Số lượng công việc theo tỉnh thành' },
                xAxis: { type: 'category', title: { text: 'Tỉnh thành' } },
                yAxis: { title: { text: 'Số lượng công việc' } },
                series: [{ name: 'Công việc', data: chartData1 }]
            });

            // 2. Tỷ lệ công việc theo loại hình
            const jobCountByType = jobs.reduce((acc, job) => {
                acc[job.type] = (acc[job.type] || 0) + job.amount;
                return acc;
            }, {});
            const chartData2 = Object.entries(jobCountByType).map(([type, count]) => ({ name: type, y: count }));

            Highcharts.chart('typeChart', {
                chart: { type: 'pie' },
                title: { text: 'Tỷ lệ công việc theo loại hình' },
                series: [{ name: 'Công việc', colorByPoint: true, data: chartData2 }]
            });

            // 3. Mức lương trung bình theo cấp bậc
            const salaryByRank = jobs.reduce((acc, job) => {
                acc[job.level] = acc[job.level] || { total: 0, count: 0 };
                acc[job.level].total += (job.minWage + job.maxWage) / 2;
                acc[job.level].count++;
                return acc;
            }, {});
            const chartData3 = Object.entries(salaryByRank).map(([rank, { total, count }]) => ({ name: rank, y: total / count }));

            Highcharts.chart('salaryChart', {
                chart: { type: 'line' },
                title: { text: 'Mức lương trung bình theo cấp bậc' },
                xAxis: { type: 'category', title: { text: 'Cấp bậc' } },
                yAxis: { title: { text: 'Mức lương trung bình ($)' } },
                series: [{ name: 'Lương', data: chartData3 }]
            });

            // 4. Số lượng công việc và lương trung bình theo ngành
            const industryData = jobs.reduce((acc, job) => {
                acc[job.major] = acc[job.major] || { count: 0, totalSalary: 0, jobCount: 0 };
                acc[job.major].count++;
                acc[job.major].totalSalary += (job.minWage + job.maxWage) / 2;
                acc[job.major].jobCount += job.amount;
                return acc;
            }, {});
            const chartData4Jobs = Object.entries(industryData).map(([industry, { jobCount }]) => ({ name: industry, y: jobCount }));
            const chartData4Salary = Object.entries(industryData).map(([industry, { totalSalary, count }]) => ({ name: industry, y: totalSalary / count }));

            Highcharts.chart('combinedChart', {
                chart: { type: 'column' },
                title: { text: 'Số lượng công việc và lương trung bình theo ngành' },
                xAxis: { type: 'category', title: { text: 'Ngành nghề' } },
                yAxis: [{
                    title: { text: 'Số lượng công việc' },
                    opposite: false
                }, {
                    title: { text: 'Mức lương trung bình ($)' },
                    opposite: true  // trục phải
                }],
                series: [{
                    name: 'Công việc',
                    data: chartData4Jobs
                }, {
                    name: 'Lương',
                    type: 'line',
                    yAxis: 1,
                    data: chartData4Salary
                }]
            });
        }
    </script>

</body>
</html>
